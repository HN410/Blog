<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>フォントを生成するGANを作った話(後編) | HNのブログ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="2021 ISer Advent Calendar 23日目の記事です． まだ前回の記事を読んでいない，あるいはもう忘れたという方は前回の記事を読まれることをお勧めします． 訓練１ さて，ようやく訓練フェーズに入ったわけですが，前述のネットワークをそのまま訓練しようとすると，非常に時間がかかるので，段階的に訓練していきます．まずはモデルの低層部分である，文字の画像を次元削減し，再び文字の画像を生成">
<meta property="og:type" content="article">
<meta property="og:title" content="フォントを生成するGANを作った話(後編)">
<meta property="og:url" content="https://hn410.github.io/blog/2021/12/23/20211223/index.html">
<meta property="og:site_name" content="HNのブログ">
<meta property="og:description" content="2021 ISer Advent Calendar 23日目の記事です． まだ前回の記事を読んでいない，あるいはもう忘れたという方は前回の記事を読まれることをお勧めします． 訓練１ さて，ようやく訓練フェーズに入ったわけですが，前述のネットワークをそのまま訓練しようとすると，非常に時間がかかるので，段階的に訓練していきます．まずはモデルの低層部分である，文字の画像を次元削減し，再び文字の画像を生成">
<meta property="og:locale" content="ja_JP">
<meta property="og:image" content="https://hn410.github.io/blog/images/20211223/cEncoder.png">
<meta property="og:image" content="https://hn410.github.io/blog/images/20211223/difficult.png">
<meta property="og:image" content="https://hn410.github.io/blog/images/20211223/wt_.png">
<meta property="og:image" content="https://hn410.github.io/blog/images/20211223/diff.png">
<meta property="og:image" content="https://hn410.github.io/blog/images/20211223/training.png">
<meta property="og:image" content="https://hn410.github.io/blog/images/20211223/valid1.png">
<meta property="og:image" content="https://hn410.github.io/blog/images/20211223/valid2.png">
<meta property="og:image" content="https://hn410.github.io/blog/images/20211223/train.png">
<meta property="og:image" content="https://hn410.github.io/blog/images/20211223/gaba.png">
<meta property="article:published_time" content="2021-12-22T15:00:00.000Z">
<meta property="article:modified_time" content="2021-12-22T15:49:59.078Z">
<meta property="article:author" content="HN">
<meta property="article:tag" content="GAN">
<meta property="article:tag" content="深層学習">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hn410.github.io/blog/images/20211223/cEncoder.png">
  
    <link rel="alternate" href="/blog/atom.xml" title="HNのブログ" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/blog/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/blog/css/style.css">

  
    
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.min.css">

  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">HNのブログ</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSSフィード"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="検索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="検索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://hn410.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-20211223" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2021/12/23/20211223/" class="article-date">
  <time class="dt-published" datetime="2021-12-22T15:00:00.000Z" itemprop="datePublished">2021-12-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/%E6%B7%B1%E5%B1%A4%E5%AD%A6%E7%BF%92/">深層学習</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      フォントを生成するGANを作った話(後編)
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>2021 ISer Advent Calendar 23日目の記事です．</p>
<p>まだ前回の記事を読んでいない，あるいはもう忘れたという方は<a href="/blog/2021/12/19/20211219/">前回の記事</a>を読まれることをお勧めします．</p>
<h2 id="訓練１">訓練１</h2>
<p>さて，ようやく訓練フェーズに入ったわけですが，前述のネットワークをそのまま訓練しようとすると，非常に時間がかかるので，段階的に訓練していきます．まずはモデルの低層部分である，文字の画像を次元削減し，再び文字の画像を生成する部分（いわゆるオートエンコーダ）を学習します．下図のようにGeneratorの低層部分の出力から画像を生成し，元の文字の画像と一致するように訓練させることを順に行います．</p>
<img src="/blog/images/20211223/cEncoder.png" width="100%">
<div style="text-align: center;font-size: 100%">  該当するモデルの図．
</div> 
<p>ここで難しいのが，どの程度までこのモデルを訓練させるかです．変換できる文字の種類を今回学習する文字<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>に限ってしまえば，母集団＝標本となるため，過適合がなく，訓練すればするほど精度が上昇するのですが，それ以外の文字もある程度変換できるようにしたい場合は早期に切り上げる必要があります．</p>
<p>今回は，頻出する構造がはっきりと再現できる程度に訓練をしました．特に再現に時間がかかった構造としては，かなの半濁点，諫などの内部の点，馬へんなどのれんがの部分があります．</p>
<img src="/blog/images/20211223/difficult.png" width="50%">
<div style="text-align: center;font-size: 100%">  訓練途中の結果．それぞれ左側は入力，右側が出力された画像となっている．
</div> 
<img src="/blog/images/20211223/wt_.png" width="25%">
<div style="text-align: center;font-size: 100%">  誰ですかこんな漢字を考えたのは．
</div> 
<p>また，この訓練の損失関数は初めはL1損失を用いました．フォント画像を出力するので，ぼやけた画像よりも二値化されたような画像のほうが望ましいためこの選択をしたのですが，意外と学習が遅く，数千エポック回しても下図のような細かい構造が再現できませんでした．これをもってL2損失に切り替えたところ，100エポックほどで以下のような画像を出力しました．この時は出力にシグモイド関数を挟んでいたため，L2損失を使うと勾配消失が起きるのではないかと思っていましたが…難しいものですね．</p>
<img src="/blog/images/20211223/diff.png" width="33%">
<div style="text-align: center;font-size: 100%">  左から，入力，L1損失で学習した際の出力, その後L2損失で学習した際の出力．口の横棒や，髟を見ると違いが分かりやすい．
</div> 
<h2 id="訓練2">訓練2</h2>
<p>ようやくGANとしての訓練を始められますが，その前に．Generatorが生成した画像の分類を行うDiscriminatorを説明します．</p>
<p>まず，Generatorが生成した画像か変換先のフォントの画像かを判別する通常のDiscriminatorを用意します．これには前述の画像のほかに，Genarotrに入力した画像と同じ変換先のフォントの組も同時に入れます．これにより，DiscriminatorはGeneratorが作った画像かどうかというよりは，入力された画像の文字が同じフォントに属するかという判定を行います．</p>
<p>これに加えて，入力された画像が何の文字かを判定するCharaDiscriminatorも用意しました．これは文字の代わりにそれに対応する特徴量ベクトルを出力します．訓練はこの特徴量がGenerator内のCharaEncoderの出力と一致するように行います．</p>
<p>以上の分類器とともに以下の図のように2つの損失を算出し，最小化させていくことでGeneratorを訓練していきます．同時にDiscriminatorにも損失関数を用意し，訓練させています．</p>
<img src="/blog/images/20211223/training.png" width="100%">
<div style="text-align: center;font-size: 100%">  Generatorの訓練の様子．Generatorだけでなく2つのDiscriminatorも用意して損失を算出する．
</div> 
<p>Generatorが出力した画像(とそのほか必要な入力)をそれぞれ分類器に入れ，Generator, 分類器ごとにそれぞれの損失関数を最小化しさせました．</p>
<h2 id="途中-結果">(途中)結果</h2>
<p>今のところの結果をあげておきます．</p>
<p>まずはうまくいっている(ように見える)例から．以下で挙げる画像は，左から，変換したい字(入力)，変換先の教師画像，Generatorの出力結果，変換したいフォントで書いた字の画像2組(入力)となっております．<br>
<img src="/blog/images/20211223/valid1.png" width="50%"></p>
<div style="text-align: center;font-size: 100%">  validデータの変換の例．
</div> 
この例については，教師画像とはあまり一致していないように見えますが，例えば横棒が終端が太く，それ以外は細いといった特徴は表現できているように見えます．
<p>もちろんこんなにうまくいくものばかりではありません．下のようになんか背景が真っ白になっている時があったり，<br>
<img src="/blog/images/20211223/valid2.png" width="50%"></p>
<div style="text-align: center;font-size: 100%">  validデータの変換例2．
</div> 
ゴシック体と大きく異なるフォントは全然学習できてなかったりとなかなか課題は多そうです．
<img src="/blog/images/20211223/train.png" width="50%">
<div style="text-align: center;font-size: 100%">  trainデータの変換例2．
</div> 
<p>ほかにも，</p>
<ul>
<li>明らかに他の画像の特徴で表現されている
<ul>
<li>→他の画像の学習結果が大きくでてしまった?</li>
</ul>
</li>
<li>周りに変なごみが出る(うまくいった例の画像などにも出てる)</li>
<li>^ , .などの小さい字が異様に膨らむ<br>
などの問題があります．</li>
</ul>
<p>また，フォントの大きさの変化，回転などといった特徴は表現できないことも分かっております，これはおそらくフォントのエンコードをする部分で主にConvolutionレイヤを使っているモデルを使用していることが原因だと思いますが，特に支障をきたさなそうなのでそのまま訓練を続けようと思っております<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>，</p>
<h2 id="感想">感想</h2>
<p>とにかくGenerator, Discriminatorの訓練バランス調整が難しく，崩れた途端意味のない画像しか生成しなくなるので，苦戦させられました．その調整ができても，訓練に時間がかかるという問題があり，それを改善しようとしてバランスが崩れる… というようなイタチゴッコが続いており，つらいです．</p>
<p>ただ，今のところはうまくいってそうでその点は少し気が楽なので，もう少し続けてみようと思います．</p>
<h2 id="備忘録">備忘録</h2>
<p>初めてのGANの訓練でつまずいたところ，気づいたところを書いておきます．</p>
<ul>
<li>Dのちょうどいい正解率がよくわからない
<ul>
<li>50%がちょうどいい正解率らしいけど，Dが全然学習してないときとの区別ができない</li>
<li>とりあえず65~55%あたりにしてみる</li>
</ul>
</li>
<li>G, Dのバランス調整はdropout率を動かすのが早い
<ul>
<li>Dの正解率等に応じて動的に調整できればなお楽</li>
</ul>
</li>
<li>人の実装はしっかりコードを読んで意味を確認してから使うこと
<ul>
<li>自分の直感とは違う書き方がたまにされている</li>
<li>これで損失関数の符号が逆になったまま訓練してました()</li>
</ul>
</li>
<li>メモリが足りなくなったらdel; torch.cuda.empty_cache(); gc.collect()をする
<ul>
<li>バッチサイズを大きくして訓練できる</li>
<li>でもこれをすると逆効果になることもある</li>
<li>地味に時間も食うので毎iterationやるときなどは必要がなければ使わないほうがいいかも</li>
</ul>
</li>
<li>勾配を伝播させる必要のないテンソルはdetach()で計算グラフから切り離す
<ul>
<li>しなくてもバグらないけどメモリをかなり無駄遣いする</li>
<li>GANで必須のテクニックだと思うけど意外と解説が少ない気がする</li>
</ul>
</li>
<li>line_profilerやtorchinfo.summaryで時間，メモリの無駄遣いをしているところを探す</li>
<li>損失関数をAdamにこだわらない
<ul>
<li>RMSPropやAdamWが意外といけるときもある</li>
</ul>
</li>
</ul>
<h2 id="余談">余談</h2>
<p>最後に，訓練中の出力画像を表示してくれたTensorboard君の渾身の煽りを御覧ください．</p>
<img src="/blog/images/20211223/gaba.png" width="50%">
<div style="text-align: center;font-size: 100%">  (こ)ここガバ
</div> 
<h2 id="使用させていただいたフォント">使用させていただいたフォント</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.lazypolarbear.com/entry/font-shirokuma">しろくまフォント</a></li>
<li><a target="_blank" rel="noopener" href="http://zone108.main.jp/font/fz-imokenpi.html">FZイモケンピ</a></li>
<li><a target="_blank" rel="noopener" href="https://fontgraphic.jp/fgtogebara">棘薔薇フォント</a></li>
<li><a target="_blank" rel="noopener" href="http://kokagem.sakura.ne.jp/font/mochi/">Nuきなこもち</a></li>
</ul>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>ASCII文字，かな，JIS第一，第二水準の漢字 <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>むしろそのような変化を吸収出来たほうが都合よい気がします(写真で撮影したものからフォントを生成したいときなど) <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hn410.github.io/blog/2021/12/23/20211223/" data-id="ckxhq2dzy0000tsv7f9iw724y" data-title="フォントを生成するGANを作った話(後編)" class="article-share-link">共有</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/GAN/" rel="tag">GAN</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E6%B7%B1%E5%B1%A4%E5%AD%A6%E7%BF%92/" rel="tag">深層学習</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/blog/2021/12/19/20211219/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前の記事</strong>
      <div class="article-nav-title">フォントを生成するGANを作った話(前編)</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">カテゴリ</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E6%B7%B1%E5%B1%A4%E5%AD%A6%E7%BF%92/">深層学習</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグ</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/GAN/" rel="tag">GAN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E6%B7%B1%E5%B1%A4%E5%AD%A6%E7%BF%92/" rel="tag">深層学習</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">タグクラウド</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/GAN/" style="font-size: 10px;">GAN</a> <a href="/blog/tags/%E6%B7%B1%E5%B1%A4%E5%AD%A6%E7%BF%92/" style="font-size: 10px;">深層学習</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">アーカイブ</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/12/">12月 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最近の投稿</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2021/12/23/20211223/">フォントを生成するGANを作った話(後編)</a>
          </li>
        
          <li>
            <a href="/blog/2021/12/19/20211219/">フォントを生成するGANを作った話(前編)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 HN<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/blog/js/jquery-3.4.1.min.js"></script>



  
<script src="/blog/fancybox/jquery.fancybox.min.js"></script>




<script src="/blog/js/script.js"></script>





  </div>
</body>
</html>